name: "Sentry self-hosted end-to-end tests"
inputs:
  project_name:
    required: true
    description: "e.g. snuba, sentry, relay, self-hosted"
# TODO: figure out inputs for containers
runs:
  using: "composite"
  steps:
    # Note: we cannot checkout the project here because we need relay to build relay-deps
    - name: Check project checkout is present at the correct path
      run: test -d ${{ inputs.project_name }}
    - name: Checkout self-hosted if needed by another project
      if: ${{ inputs.project_name != "self-hosted" }}
      uses: actions/checkout@v3
      with:
        repository: "getsentry/self-hosted"
        ref: 
        path: self-hosted
    - name: Check needed project containers are built
      if: ${{ inputs.project_name != "self-hosted" }}
      run: test "$(docker images -q ${{ inputs.project_name }} 2> /dev/null)" == ""
    - name: Run the installer
      run: ./self-hosted/install.sh --no-report-self-hosted-issues
    - name: Run tests
      run: |
        set +e
        ./self-hosted/test.sh
        test_returns=$?
        set -e
        if [[ $test_return -ne 0 ]]; then
          echo "Test failed.";
          docker-compose ps;
          docker-compose logs;
          exit $test_return;
        fi
 
        
    

